<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <title>WebCrawler</title>
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .blur-load {
        filter: blur(5px);
        transition: filter 1s ease-in-out;
      }
      .blur-load.loaded {
        filter: blur(0);
      }
      .slide-up {
        transition: transform 0.5s ease-in-out;
      }
      .slid-up {
        transform: translateY(-20px);
      }
      .gradient-border {
        position: relative;
        border-radius: 0.5rem;
      }
      .gradient-border::after {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #6366f1, #8b5cf6, #ec4899);
        border-radius: 0.6rem;
        z-index: -1;
      }
      .bg-grid {
        background-image: radial-gradient(
          rgba(255, 255, 255, 0.1) 1px,
          transparent 1px
        );
        background-size: 20px 20px;
      }
      .glow {
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937;
      }
      ::-webkit-scrollbar-thumb {
        background: #4f46e5;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #4338ca;
      }

      /* Additional utility classes */
      .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
      }
      .hover-scale {
        transition: transform 0.2s ease-in-out;
      }
      .hover-scale:hover {
        transform: scale(1.05);
      }
      .glass-effect {
        background: rgba(31, 41, 55, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .tab-button {
        @apply px-4 py-2 text-lg font-medium text-gray-400 hover:text-indigo-400 border-b-2 border-transparent hover:border-indigo-400;
      }
      .tab-button.active {
        @apply text-indigo-400 border-indigo-500;
      }
      .loading {
        opacity: 0.5;
        pointer-events: none;
      }
      .loading-spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .toaster-enter {
        animation: slideIn 0.3s ease-out;
      }
      .toaster-exit {
        animation: slideOut 0.3s ease-in;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    </style>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f5f3ff",
                100: "#ede9fe",
                200: "#ddd6fe",
                300: "#c4b5fd",
                400: "#a78bfa",
                500: "#8b5cf6",
                600: "#7c3aed",
                700: "#6d28d9",
                800: "#5b21b6",
                900: "#4c1d95",
              },
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen bg-grid">
    <div class="container mx-auto px-4 md:px-28 py-8">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center space-x-3">
          <svg
            class="w-10 h-10 text-indigo-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19.828 4.172a4 4 0 00-5.656 0l-4.172 4.172 5.656 5.656 4.172-4.172a4 4 0 000-5.656zM9.172 14.828L4 20l5.172-1.172L15 13l-4 4-1.828 1.828z"
            ></path>
          </svg>
          <h1
            class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"
          >
            WebCrawler
          </h1>
        </div>
        <div class="text-gray-400">
          Last updated: <span id="current-time">May 14, 2025</span>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mb-6 border-b border-gray-700">
        <div class="flex space-x-8">
          <button
            id="tab-analytics"
            class="px-4 py-2 text-lg font-medium text-gray-400 hover:text-indigo-400 border-b-2 border-transparent hover:border-indigo-400 tab-button active"
            data-tab="analytics-content"
          >
            Website Analytics
          </button>
          <button
            id="tab-domains"
            class="px-4 py-2 text-lg font-medium text-gray-400 hover:text-indigo-400 border-b-2 border-transparent hover:border-indigo-400 tab-button"
            data-tab="domains-content"
          >
            Domain Discovery
          </button>
        </div>
      </div>

      <!-- Analytics Tab Content -->
      <div id="analytics-content" class="tab-content active space-y-12">
        <div class="flex items-center justify-between">
          <div class="inline-flex flex-col items-start">
            <div class="flex items-center space-x-2">
              <span
                class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 whitespace-nowrap"
                >Juice Shop</span
              >
              <span
                class="mt-2 text-xl font-bold whitespace-nowrap text-gray-400"
                >- Analytics</span
              >
            </div>
            <p class="text-gray-400 block truncate">http://13.60.183.62/</p>
          </div>
          <!-- TIme frame input filter -->
          <div class="flex items-center space-x-4">
            <select
              id="time-frame"
              class="bg-gray-800 border border-gray-700 text-gray-400 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5"
            >
              <option value="all">All Time</option>
              <option value="last-24-hours">Last 24 Hours</option>
              <option value="last-week">Last Week</option>
              <option value="last-month">Last Month</option>
            </select>
            <button
              id="reload-analytics"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2"
              onclick="reloadAnalytics()"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Reload
            </button>
          </div>
        </div>

        <!-- Results Container (Initially Hidden) -->
        <div id="results-container" class="space-y-8">
          <!-- Overview Stats -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="p-6 bg-gray-800 rounded-lg shadow-lg gradient-border">
              <div class="flex justify-between">
                <div>
                  <p class="font-medium text-gray-400">Total Visitors</p>
                  <h3 class="text-3xl font-bold text-white" id="total-visitors">
                    --
                  </h3>
                </div>
                <div class="p-3 rounded-full bg-indigo-900/30 text-indigo-500">
                  <svg
                    class="w-8 h-8"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="mt-2">
                <div class="flex items-center">
                  <span class="text-green-500 font-medium flex items-center">
                    <svg
                      class="w-4 h-4 mr-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 10l7-7m0 0l7 7m-7-7v18"
                      ></path>
                    </svg>
                    12.5%
                  </span>
                  <span class="text-gray-400 ml-2">from last period</span>
                </div>
              </div>
            </div>

            <div class="p-6 bg-gray-800 rounded-lg shadow-lg gradient-border">
              <div class="flex justify-between">
                <div>
                  <p class="font-medium text-gray-400">Avg. Time on Site</p>
                  <h3 class="text-3xl font-bold text-white" id="avg-time">
                    --
                  </h3>
                </div>
                <div class="p-3 rounded-full bg-purple-900/30 text-purple-500">
                  <svg
                    class="w-8 h-8"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="mt-2">
                <div class="flex items-center">
                  <span class="text-green-500 font-medium flex items-center">
                    <svg
                      class="w-4 h-4 mr-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 10l7-7m0 0l7 7m-7-7v18"
                      ></path>
                    </svg>
                    8.1%
                  </span>
                  <span class="text-gray-400 ml-2">from last period</span>
                </div>
              </div>
            </div>

            <div class="p-6 bg-gray-800 rounded-lg shadow-lg gradient-border">
              <div class="flex justify-between">
                <div>
                  <p class="font-medium text-gray-400">Top Region</p>
                  <h3 class="text-3xl font-bold text-white" id="top-region">
                    --
                  </h3>
                </div>
                <div class="p-3 rounded-full bg-pink-900/30 text-pink-500">
                  <svg
                    class="w-8 h-8"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="mt-2">
                <div class="text-gray-400 text-sm">
                  <span class="font-medium text-white">67%</span> of total
                  traffic
                </div>
              </div>
            </div>

            <div class="p-6 bg-gray-800 rounded-lg shadow-lg gradient-border">
              <div class="flex justify-between">
                <div>
                  <p class="font-medium text-gray-400">Bounce Rate</p>
                  <h3 class="text-3xl font-bold text-white" id="bounce-rate">
                    --
                  </h3>
                </div>
                <div class="p-3 rounded-full bg-blue-900/30 text-blue-500">
                  <svg
                    class="w-8 h-8"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="mt-2">
                <div class="flex items-center">
                  <span class="text-red-500 font-medium flex items-center">
                    <svg
                      class="w-4 h-4 mr-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 14l-7 7m0 0l-7-7m7 7V3"
                      ></path>
                    </svg>
                    3.2%
                  </span>
                  <span class="text-gray-400 ml-2">from last period</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Visitors by Region -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 blur-load">
              <h3 class="text-lg font-medium text-white mb-4">
                Visitors by Region
              </h3>
              <div class="h-80">
                <canvas id="region-chart"></canvas>
              </div>
            </div>

            <!-- Geographic Distribution -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 blur-load">
              <h3 class="text-lg font-medium text-white mb-4">
                Geographic Distribution
              </h3>
              <div class="h-80">
                <canvas id="geo-chart"></canvas>
              </div>
            </div>

            <!-- Time Spent Analysis -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 blur-load">
              <h3 class="text-lg font-medium text-white mb-4">
                Time Spent Analysis
              </h3>
              <div class="h-80">
                <canvas id="time-chart"></canvas>
              </div>
            </div>

            <!-- Traffic Distribution -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 blur-load">
              <h3 class="text-lg font-medium text-white mb-4">
                Traffic Distribution (24h)
              </h3>
              <div class="h-80">
                <canvas id="traffic-chart"></canvas>
              </div>
            </div>
          </div>

          <!-- Data Table -->
          <div
            class="bg-gray-800 rounded-lg shadow-lg overflow-hidden blur-load"
          >
            <div
              class="flex justify-between items-center p-6 border-b border-gray-700"
            >
              <h3 class="text-lg font-medium text-white">
                Detailed Visitor Data
              </h3>
              <div class="flex space-x-2">
                <button class="p-2 text-gray-400 hover:text-white">
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                    ></path>
                  </svg>
                </button>
                <button class="p-2 text-gray-400 hover:text-white">
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                  <tr>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      IP Address
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Location
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Region
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Time Spent
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Pages Viewed
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Last Visit
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="visitor-data"
                  class="bg-gray-800 divide-y divide-gray-700"
                >
                  <!-- Data will be inserted here -->
                </tbody>
              </table>
            </div>
            <div
              class="flex items-center justify-between p-4 border-t border-gray-700"
            >
              <div class="text-gray-400">
                Showing <span class="font-medium text-white">1</span> to
                <span class="font-medium text-white">10</span> of
                <span class="font-medium text-white">--</span> results
              </div>
              <div class="flex space-x-2">
                <button
                  class="px-3 py-1 rounded text-gray-400 hover:text-white hover:bg-gray-700"
                >
                  Previous
                </button>
                <button class="px-3 py-1 rounded bg-indigo-600 text-white">
                  1
                </button>
                <button
                  class="px-3 py-1 rounded text-gray-400 hover:text-white hover:bg-gray-700"
                >
                  2
                </button>
                <button
                  class="px-3 py-1 rounded text-gray-400 hover:text-white hover:bg-gray-700"
                >
                  Next
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Domains Tab Content -->
      <div id="domains-content" class="tab-content">
        <!-- Domain Discovery Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div
            class="p-6 bg-gray-800 rounded-lg shadow-lg gradient-border glow"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-gray-400">Discovered Domains</p>
                <h3
                  class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400"
                  id="found-domains"
                >
                  0
                </h3>
              </div>
              <div class="p-3 rounded-full bg-indigo-900/30 text-indigo-400">
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c-1.657 0-3-4.03-3-9s1.343-9 3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
                  ></path>
                </svg>
              </div>
            </div>
          </div>

          <div
            class="p-6 bg-gray-800 rounded-lg shadow-lg gradient-border glow"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-gray-400">Scan Duration</p>
                <h3
                  class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-orange-400"
                  id="scan-duration"
                >
                  0s
                </h3>
              </div>
              <div class="p-3 rounded-full bg-red-900/30 text-red-400">
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
            </div>
          </div>

          <div
            class="p-6 bg-gray-800 rounded-lg shadow-lg gradient-border glow"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-gray-400">Search Engines</p>
                <h3
                  class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-red-400"
                  id="search-engines"
                >
                  0
                </h3>
              </div>
              <div class="p-3 rounded-full bg-pink-900/30 text-pink-400">
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  ></path>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-1 mb-8 space-y-4">
          <!-- Discovered domains - spans 8 columns -->
          <div
            class="md:col-span-8 bg-gray-800 rounded-lg shadow-lg overflow-hidden"
          >
            <div
              class="flex justify-between items-center p-6 border-b border-gray-700"
            >
              <h3 class="text-2xl font-medium">Discovered .rw Domains</h3>
              <button
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hidden md:inline hover:bg-indigo-700"
                id="scan-button"
                onclick="reloadDomains()"
              >
                <svg
                  class="w-5 h-5 inline-block mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  ></path>
                </svg>
                <span class="hidden md:inline">Reload</span>
              </button>
            </div>
            <div class="p-6">
              <div class="relative">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none w-1/2"
                >
                  <svg
                    class="h-5 w-5 text-gray-400"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <input
                  type="text"
                  id="domain-search"
                  placeholder="Search domains..."
                  class="bg-gray-700 border border-gray-600 text-white rounded-lg block w-full pl-10 p-2.5 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                  <tr>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Domain
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Discovered On
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                    >
                      Open
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="domain-list"
                  class="bg-gray-800 divide-y divide-gray-700"
                >
                  <!-- Domain data will be inserted here -->
                </tbody>
              </table>
            </div>
            <div
              class="flex items-center justify-between p-4 border-t border-gray-700"
            >
              <div class="text-gray-400" id="pagination-info">
                Showing <span class="font-medium text-white">1</span> to
                <span class="font-medium text-white">10</span> of
                <span class="font-medium text-white" id="total-domains">0</span>
                domains
              </div>
              <div class="flex space-x-2" id="pagination-buttons">
                <button
                  class="px-3 py-1 rounded text-gray-400 hover:text-white hover:bg-gray-700"
                >
                  Previous
                </button>
                <button class="px-3 py-1 rounded bg-indigo-600 text-white">
                  1
                </button>
                <button
                  class="px-3 py-1 rounded text-gray-400 hover:text-white hover:bg-gray-700"
                >
                  Next
                </button>
              </div>
            </div>
          </div>

          <!-- Search engines - spans 4 columns -->
          <div
            class="md:col-span-4 bg-gray-800 rounded-lg shadow-lg overflow-hidden h-fit"
          >
            <div
              class="flex justify-between items-center p-6 border-b border-gray-700"
            >
              <h3 class="text-2xl font-medium">Search Engines</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full table-fixed divide-y divide-gray-700">
                <thead class="bg-gray-700">
                  <tr>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/2"
                    >
                      Search Engine
                    </th>
                    <th
                      scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/2"
                    >
                      Last Scan
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="search-engine-list"
                  class="bg-gray-800 divide-y divide-gray-700"
                >
                  <!-- Search engine data will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Toaster Container -->
    <div id="toaster" class="fixed bottom-4 right-4 z-50 hidden">
      <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg border border-gray-700 flex items-center gap-2">
        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span id="toaster-message"></span>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Pagination variables
      const itemsPerPage = 10;
      let currentPage = 1;
      let totalPages = 1;
      let sortedDomains = [];

      // Tab switching functionality
      document.querySelectorAll(".tab-button").forEach((button) => {
        button.addEventListener("click", () => {
          // Remove active state from all tabs and content
          document.querySelectorAll(".tab-button").forEach((tab) => {
            tab.classList.remove(
              "active",
              "text-indigo-400",
              "border-indigo-500"
            );
            tab.classList.add("text-gray-400", "border-transparent");
          });
          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.remove("active");
          });

          // Add active state to clicked tab and its content
          button.classList.remove("text-gray-400", "border-transparent");
          button.classList.add(
            "active",
            "text-indigo-400",
            "border-indigo-500"
          );
          document.getElementById(button.dataset.tab).classList.add("active");
        });
      });

      // Set initial active state for Website Analytics tab
      document.addEventListener("DOMContentLoaded", () => {
        const analyticsTab = document.getElementById("tab-analytics");
        if (analyticsTab) {
          analyticsTab.classList.remove("text-gray-400", "border-transparent");
          analyticsTab.classList.add(
            "active",
            "text-indigo-400",
            "border-indigo-500"
          );
          document.getElementById("analytics-content").classList.add("active");
        }
      });

      // Update current time
      function updateCurrentTime(timestamp) {
        const now = timestamp ? new Date(timestamp) : new Date();
        document.getElementById("current-time").textContent =
          now.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
      }

      // Initialize charts when content is loaded
      document.querySelectorAll(".blur-load").forEach((element) => {
        element.classList.add("loaded");
      });

      // Chart configurations and initialization
      const chartConfigs = {
        region: {
          type: "doughnut",
          data: {
            labels: ["Kigali", "Eastern", "Western", "Northern", "Southern"],
            datasets: [
              {
                data: [45, 20, 15, 12, 8],
                backgroundColor: [
                  "#8B5CF6",
                  "#EC4899",
                  "#3B82F6",
                  "#10B981",
                  "#F59E0B",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  color: "#E5E7EB",
                  font: {
                    size: 12,
                  },
                },
              },
            },
          },
        },
        time: {
          type: "line",
          data: {
            labels: [], // Will be populated with timestamps
            datasets: [
              {
                label: "Time Spent (seconds)",
                data: [], // Will be populated with time_spent values
                borderColor: "#8B5CF6",
                tension: 0.4,
                fill: true,
                backgroundColor: "rgba(139, 92, 246, 0.1)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: "#E5E7EB" },
              },
            },
            scales: {
              y: {
                grid: { color: "rgba(255, 255, 255, 0.1)" },
                ticks: {
                  color: "#E5E7EB",
                  callback: (value) => formatDuration(value),
                },
              },
              x: {
                grid: { color: "rgba(255, 255, 255, 0.1)" },
                ticks: {
                  color: "#E5E7EB",
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
            },
          },
        },
        traffic: {
          type: "bar",
          data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
            datasets: [
              {
                label: "Visitors",
                data: Array.from({ length: 24 }, () =>
                  Math.floor(Math.random() * 1000)
                ),
                backgroundColor: "#8B5CF6",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: "#E5E7EB",
                },
              },
            },
            scales: {
              y: {
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#E5E7EB",
                },
              },
              x: {
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#E5E7EB",
                },
              },
            },
          },
        },
        engagement: {
          type: "radar",
          data: {
            labels: [
              "Pages/Visit",
              "Avg. Time",
              "Bounce Rate",
              "New Visitors",
              "Return Rate",
            ],
            datasets: [
              {
                label: "Current Period",
                data: [4.2, 3.8, 2.5, 4.0, 3.5],
                backgroundColor: "rgba(139, 92, 246, 0.2)",
                borderColor: "#8B5CF6",
                pointBackgroundColor: "#8B5CF6",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: "#E5E7EB",
                },
              },
            },
            scales: {
              r: {
                angleLines: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                pointLabels: {
                  color: "#E5E7EB",
                },
                ticks: {
                  color: "#E5E7EB",
                  backdropColor: "transparent",
                },
              },
            },
          },
        },
        geo: {
          type: "bubble",
          data: {
            datasets: [
              {
                label: "Visitors by Location",
                data: [
                  { x: 30.0619, y: -1.9441, r: 20, location: "Kigali" },
                  { x: 30.4358, y: -2.5967, r: 15, location: "Huye" },
                  { x: 29.74, y: -1.95, r: 12, location: "Gisenyi" },
                  { x: 30.0588, y: -1.9403, r: 10, location: "Kibuye" },
                  { x: 29.75, y: -2.4667, r: 8, location: "Butare" },
                ],
                backgroundColor: "rgba(139, 92, 246, 0.6)",
                borderColor: "#8B5CF6",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return context.raw.location;
                  },
                },
              },
            },
            scales: {
              x: {
                type: "linear",
                position: "bottom",
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#E5E7EB",
                },
              },
              y: {
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#E5E7EB",
                },
              },
            },
          },
        },
      };

      // Initialize all charts
      const charts = {};
      Object.keys(chartConfigs).forEach((key) => {
        const canvas = document.getElementById(`${key}-chart`);
        if (canvas) {
          charts[key] = new Chart(canvas, chartConfigs[key]);
        }
      });

      // Sample data for visitor table
      const visitorData = [
        {
          ip: "196.223.128.1",
          location: "Kigali, Rwanda",
          region: "Kigali",
          timeSpent: "4:30",
          pagesViewed: 4,
          lastVisit: "2024-03-15 14:30",
        },
        {
          ip: "196.223.129.45",
          location: "Huye, Rwanda",
          region: "Southern",
          timeSpent: "3:45",
          pagesViewed: 3,
          lastVisit: "2024-03-15 14:25",
        },
        {
          ip: "196.223.130.78",
          location: "Gisenyi, Rwanda",
          region: "Western",
          timeSpent: "3:15",
          pagesViewed: 2,
          lastVisit: "2024-03-15 14:20",
        },
        {
          ip: "196.223.131.92",
          location: "Kibuye, Rwanda",
          region: "Western",
          timeSpent: "2:45",
          pagesViewed: 2,
          lastVisit: "2024-03-15 14:15",
        },
        {
          ip: "196.223.132.34",
          location: "Butare, Rwanda",
          region: "Southern",
          timeSpent: "2:30",
          pagesViewed: 1,
          lastVisit: "2024-03-15 14:10",
        },
      ];

      // Function to render domains for current page
      function renderDomains() {
        const domainTableBody = document.getElementById("domain-list");
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageDomains = sortedDomains.slice(start, end);

        // Clear existing rows
        domainTableBody.innerHTML = "";

        // Add new rows
        pageDomains.forEach((domain) => {
          try {
            const domainName =
              typeof domain === "string"
                ? domain
                : domain.domain || domain.name || JSON.stringify(domain);
            const row = document.createElement("tr");
            // Replace the existing date formatting in renderDomains function
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">${domainName}</td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">${formatDateTime(
                domain.discovered_at || domain.discovered_on
              )}</td>
              <td class="px-6 py-4 whitespace-nowrap text-indigo-400 hover:text-indigo-300 cursor-pointer">
                <a href="${
                  domain.url || "#"
                }" target="_blank" class="flex items-center gap-1">
                  Open
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </a>
              </td>
            `;
            domainTableBody.appendChild(row);
          } catch (error) {
            console.error("Error creating row for domain:", domain, error);
          }
        });

        // Update pagination info
        const paginationInfo = document.getElementById("pagination-info");
        if (paginationInfo) {
          paginationInfo.innerHTML = `
            Showing <span class="font-medium text-white">${start + 1}</span> to
            <span class="font-medium text-white">${Math.min(
              end,
              sortedDomains.length
            )}</span> of
            <span class="font-medium text-white">${
              sortedDomains.length
            }</span> domains
          `;
        }

        // Update pagination buttons
        const paginationContainer =
          document.getElementById("pagination-buttons");
        if (paginationContainer) {
          paginationContainer.innerHTML = "";

          // Previous button
          const prevButton = document.createElement("button");
          prevButton.className = `px-3 py-1 rounded ${
            currentPage === 1
              ? "text-gray-500 cursor-not-allowed"
              : "text-gray-400 hover:text-white hover:bg-gray-700"
          }`;
          prevButton.textContent = "Previous";
          prevButton.disabled = currentPage === 1;
          prevButton.onclick = () => {
            if (currentPage > 1) {
              currentPage--;
              renderDomains();
            }
          };
          paginationContainer.appendChild(prevButton);

          // Calculate page range to show
          const maxVisiblePages = 5;
          let startPage = Math.max(
            1,
            currentPage - Math.floor(maxVisiblePages / 2)
          );
          let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

          // Adjust start page if we're near the end
          if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
          }

          // First page button if not in range
          if (startPage > 1) {
            const firstPageButton = document.createElement("button");
            firstPageButton.className =
              "px-3 py-1 rounded text-gray-400 hover:text-white hover:bg-gray-700";
            firstPageButton.textContent = "1";
            firstPageButton.onclick = () => {
              currentPage = 1;
              renderDomains();
            };
            paginationContainer.appendChild(firstPageButton);

            // Ellipsis if needed
            if (startPage > 2) {
              const ellipsis = document.createElement("span");
              ellipsis.className = "px-2 text-gray-400";
              ellipsis.textContent = "...";
              paginationContainer.appendChild(ellipsis);
            }
          }

          // Page numbers
          for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement("button");
            pageButton.className = `px-3 py-1 rounded ${
              currentPage === i
                ? "bg-indigo-600 text-white"
                : "text-gray-400 hover:text-white hover:bg-gray-700"
            }`;
            pageButton.textContent = i;
            pageButton.onclick = () => {
              currentPage = i;
              renderDomains();
            };
            paginationContainer.appendChild(pageButton);
          }

          // Last page button if not in range
          if (endPage < totalPages) {
            // Ellipsis if needed
            if (endPage < totalPages - 1) {
              const ellipsis = document.createElement("span");
              ellipsis.className = "px-2 text-gray-400";
              ellipsis.textContent = "...";
              paginationContainer.appendChild(ellipsis);
            }

            const lastPageButton = document.createElement("button");
            lastPageButton.className =
              "px-3 py-1 rounded text-gray-400 hover:text-white hover:bg-gray-700";
            lastPageButton.textContent = totalPages;
            lastPageButton.onclick = () => {
              currentPage = totalPages;
              renderDomains();
            };
            paginationContainer.appendChild(lastPageButton);
          }

          // Next button
          const nextButton = document.createElement("button");
          nextButton.className = `px-3 py-1 rounded ${
            currentPage === totalPages
              ? "text-gray-500 cursor-not-allowed"
              : "text-gray-400 hover:text-white hover:bg-gray-700"
          }`;
          nextButton.textContent = "Next";
          nextButton.disabled = currentPage === totalPages;
          nextButton.onclick = () => {
            if (currentPage < totalPages) {
              currentPage++;
              renderDomains();
            }
          };
          paginationContainer.appendChild(nextButton);
        }
      }

      // Function to format duration in a human-readable way
      function formatDuration(seconds) {
        if (!seconds) return "0s";

        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = seconds % 60;

        const parts = [];
        if (hours > 0) parts.push(`${hours}h`);
        if (minutes > 0) parts.push(`${minutes}m`);
        if (remainingSeconds > 0 || parts.length === 0)
          parts.push(`${remainingSeconds}s`);

        return parts.join(" ");
      }

      // Function to parse Python timedelta string (e.g., '0:00:03.188102') to seconds
      function parsePythonTimedelta(timedeltaStr) {
        if (!timedeltaStr || typeof timedeltaStr !== "string") return null;
        // Format: H:MM:SS.microseconds
        const match = timedeltaStr.match(/^(\d+):(\d{2}):(\d{2})(?:\.(\d+))?$/);
        if (!match) return null;
        const hours = parseInt(match[1], 10);
        const minutes = parseInt(match[2], 10);
        const seconds = parseInt(match[3], 10);
        // Ignore microseconds for display
        return hours * 3600 + minutes * 60 + seconds;
      }

      // Function to update scan duration
      function updateScanDuration(duration) {
        const scanDurationSpan = document.getElementById("scan-duration");
        if (scanDurationSpan) {
          if (typeof duration === "string") {
            // Try to parse as Python timedelta string
            const seconds = parsePythonTimedelta(duration);
            if (seconds !== null) {
              scanDurationSpan.textContent = formatDuration(seconds);
            } else {
              scanDurationSpan.textContent = duration;
            }
          } else if (typeof duration === "number") {
            scanDurationSpan.textContent = formatDuration(duration);
          } else {
            scanDurationSpan.textContent = "0s";
          }
        }
      }

      // Function to update domain list
      function updateDomainList(data) {
        const totalDomainsSpan = document.getElementById("total-domains");
        const foundDomainsSpan = document.getElementById("found-domains");
        const searchEnginesSpan = document.getElementById("search-engines");

        // Get domains array from the response
        const domains = data.domains || [];

        // Update total domains count
        if (totalDomainsSpan) {
          totalDomainsSpan.textContent = domains.length;
        }
        if (foundDomainsSpan) {
          foundDomainsSpan.textContent = domains.length;
        }

        // Update metadata if available
        const metadata = data.metadata || {};
        if (searchEnginesSpan) {
          searchEnginesSpan.textContent = metadata.search_engines?.length || 0;
        }

        // Update scan duration with proper formatting
        updateScanDuration(metadata.crawl_duration);

        // Update last updated time
        updateCurrentTime(data.last_updated);

        // Sort domains in descending order and update global state
        sortedDomains = [...domains].reverse();
        totalPages = Math.max(
          1,
          Math.ceil(sortedDomains.length / itemsPerPage)
        );
        if (currentPage > totalPages) currentPage = totalPages;
        renderDomains();
      }

      // Update the showToaster function with animations
      function showToaster(message, duration = 3000) {
        const toaster = document.getElementById('toaster');
        const toasterMessage = document.getElementById('toaster-message');
        
        toasterMessage.textContent = message;
        toaster.classList.remove('hidden');
        toaster.classList.add('toaster-enter');
        
        setTimeout(() => {
          toaster.classList.add('toaster-exit');
          setTimeout(() => {
            toaster.classList.remove('toaster-enter', 'toaster-exit');
            toaster.classList.add('hidden');
          }, 300);
        }, duration);
      }

      // Add loading state management
      function setLoading(isLoading) {
        const elements = document.querySelectorAll('.gradient-border, .bg-gray-800');
        elements.forEach(element => {
          if (isLoading) {
            element.classList.add('loading');
          } else {
            element.classList.remove('loading');
          }
        });
      }

      // Update the fetchAnalyticsData function
      async function fetchAnalyticsData(timeFrame = 'all') {
        setLoading(true);
        try {
          const response = await fetch(`http://16.171.174.116/analytics/data`);
          const data = await response.json();

          if (data.success) {
            updateAnalyticsDashboard(data);
            showToaster('Analytics data refreshed successfully!');
          } else {
            showToaster('Error fetching analytics data', 5000);
          }
        } catch (error) {
          console.error("Error fetching analytics:", error);
          showToaster('Error fetching analytics data', 5000);
        } finally {
          setLoading(false);
        }
      }

      function updateAnalyticsDashboard(data) {
        const analytics = data.results;

        // Get unique sessions
        const uniqueSessions = [...new Set(analytics.map((a) => a.session_id))];

        // Update total visitors
        document.getElementById("total-visitors").textContent =
          uniqueSessions.length;

        // Calculate average time spent (use the most recent time_spent for each session)
        const latestSessionTimes = analytics.reduce((acc, curr) => {
          if (
            !acc[curr.session_id] ||
            acc[curr.session_id].timestamp < curr.timestamp
          ) {
            acc[curr.session_id] = curr;
          }
          return acc;
        }, {});

        const avgTimeSpent =
          Object.values(latestSessionTimes).reduce(
            (acc, curr) => acc + curr.time_spent,
            0
          ) / uniqueSessions.length;

        document.getElementById("avg-time").textContent = formatDuration(
          Math.round(avgTimeSpent)
        );

        // Get top region
        const regionCounts = analytics.reduce((acc, curr) => {
          const region = curr.region.region;
          acc[region] = (acc[region] || 0) + 1;
          return acc;
        }, {});

        const topRegion = Object.entries(regionCounts).sort(
          (a, b) => b[1] - a[1]
        )[0];

        document.getElementById("top-region").textContent = topRegion[0];

        // Calculate bounce rate (sessions with only 1 page view)
        const bounceRate =
          (uniqueSessions.filter((sessionId) => {
            const sessionEvents = analytics.filter(
              (a) => a.session_id === sessionId
            );
            return Math.max(...sessionEvents.map((e) => e.page_views)) === 1;
          }).length /
            uniqueSessions.length) *
          100;

        document.getElementById(
          "bounce-rate"
        ).textContent = `${bounceRate.toFixed(1)}%`;

        // Update all charts with real data

        // 1. Update Region Chart (Doughnut)
        if (charts.region) {
          const regionCounts = analytics.reduce((acc, curr) => {
            const region = curr.region.region;
            acc[region] = (acc[region] || 0) + 1;
            return acc;
          }, {});

          const regionData = Object.entries(regionCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

          charts.region.data.labels = regionData.map(([region]) => region);
          charts.region.data.datasets[0].data = regionData.map(
            ([, count]) => count
          );
          charts.region.update();
        }

        // 2. Update Geographic Distribution Chart (Bubble)
        if (charts.geo) {
          const locationData = analytics.reduce((acc, curr) => {
            const key = `${curr.region.city}-${curr.region.region}`;
            if (!acc[key]) {
              acc[key] = {
                count: 0,
                x: parseFloat(curr.region.longitude) || 0,
                y: parseFloat(curr.region.latitude) || 0,
                location: curr.region.city,
              };
            }
            acc[key].count++;
            return acc;
          }, {});

          const bubbleData = Object.values(locationData).map((loc) => ({
            x: loc.x,
            y: loc.y,
            r: Math.min(Math.max(loc.count * 2, 5), 20), // Scale bubble size between 5-20
            location: loc.location,
          }));

          charts.geo.data.datasets[0].data = bubbleData;
          charts.geo.update();
        }

        // 3. Update Time Spent Analysis Chart (Line)
        if (charts.time) {
          // Group data by hour and calculate average time spent
          const timeData = analytics.reduce((acc, curr) => {
            const hour = new Date(curr.timestamp).getHours();
            if (!acc[hour]) {
              acc[hour] = { total: 0, count: 0 };
            }
            acc[hour].total += curr.time_spent;
            acc[hour].count++;
            return acc;
          }, {});

          const hours = Array.from({ length: 24 }, (_, i) => i);
          const avgTimeData = hours.map((hour) => ({
            hour,
            avg: timeData[hour]
              ? timeData[hour].total / timeData[hour].count
              : 0,
          }));

          charts.time.data.labels = avgTimeData.map((d) => `${d.hour}:00`);
          charts.time.data.datasets[0].data = avgTimeData.map((d) => d.avg);
          charts.time.update();
        }

        // 4. Update Traffic Distribution Chart (Bar)
        if (charts.traffic) {
          const hourlyTraffic = new Array(24).fill(0);
          analytics.forEach((event) => {
            const hour = new Date(event.timestamp).getHours();
            hourlyTraffic[hour]++;
          });

          charts.traffic.data.datasets[0].data = hourlyTraffic;
          charts.traffic.update();
        }

        // 5. Update Engagement Chart (Radar) if it exists
        if (charts.engagement) {
          const engagement = {
            pagesPerVisit:
              analytics.reduce((acc, curr) => acc + curr.page_views, 0) /
              analytics.length,
            avgTime:
              analytics.reduce((acc, curr) => acc + curr.time_spent, 0) /
              analytics.length,
            bounceRate:
              (analytics.filter((a) => a.page_views === 1).length /
                analytics.length) *
              100,
            newVisitors: analytics.filter((a) => a.event_type === "pageview")
              .length,
            returnRate:
              (analytics.filter((a) => a.event_type === "return_visit").length /
                analytics.length) *
              100,
          };

          charts.engagement.data.datasets[0].data = [
            engagement.pagesPerVisit,
            engagement.avgTime / 60, // Convert to minutes
            engagement.bounceRate,
            engagement.newVisitors,
            engagement.returnRate,
          ];
          charts.engagement.update();
        }

        // Update Detailed Visitor Data table
        const visitorTableBody = document.getElementById("visitor-data");
        if (visitorTableBody) {
          visitorTableBody.innerHTML = "";

          // Group analytics by session to show latest event for each visitor
          const latestSessionEvents = Object.values(
            data.results.reduce((acc, curr) => {
              if (
                !acc[curr.session_id] ||
                new Date(acc[curr.session_id].timestamp) <
                  new Date(curr.timestamp)
              ) {
                acc[curr.session_id] = curr;
              }
              return acc;
            }, {})
          );

          // Sort by timestamp descending (most recent first)
          latestSessionEvents.sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );

          latestSessionEvents.forEach((event) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                ${event.region.ip || event.request_ip || "--"}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                ${event.region.city}, ${event.region.country}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                ${event.region.region}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                ${formatDuration(event.time_spent)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                ${event.page_views}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-gray-300">
                ${formatDateTime(event.timestamp)}
              </td>
            `;
            visitorTableBody.appendChild(row);
          });

          // Update results count in pagination
          const paginationInfo = visitorTableBody
            .closest(".bg-gray-800")
            .querySelector(".text-gray-400");
          if (paginationInfo) {
            paginationInfo.innerHTML = `
              Showing <span class="font-medium text-white">1</span> to
              <span class="font-medium text-white">${latestSessionEvents.length}</span> of
              <span class="font-medium text-white">${latestSessionEvents.length}</span> results
            `;
          }
        }
      }

      // Update the reloadDomains function
      function reloadDomains() {
        const reloadIcons = document.querySelectorAll(
          "#scan-button svg, #scan-button-mobile svg"
        );
        
        reloadIcons.forEach(icon => {
          icon.classList.add('loading-spinner');
        });
        
        setLoading(true);

        fetch("/api/domains")
          .then((res) => res.json())
          .then((data) => {
            updateDomainList(data);
            showToaster('Domain data refreshed successfully!');
          })
          .catch((err) => {
            console.error("Reload error:", err);
            showToaster('Error refreshing domain data', 5000);
          })
          .finally(() => {
            setLoading(false);
            reloadIcons.forEach(icon => {
              icon.classList.remove('loading-spinner');
            });
          });
      }

      // Improve search functionality
      document.getElementById("domain-search").addEventListener("input", function (event) {
        const searchTerm = event.target.value.toLowerCase();
        const domainTableBody = document.getElementById("domain-list");
        const rows = domainTableBody.querySelectorAll("tr");
        let visibleCount = 0;

        rows.forEach((row) => {
          const domainName = row.cells[0].textContent.toLowerCase();
          const discoveredOn = row.cells[1].textContent.toLowerCase();
          
          if (domainName.includes(searchTerm) || discoveredOn.includes(searchTerm)) {
            row.style.display = "";
            visibleCount++;
          } else {
            row.style.display = "none";
          }
        });

        // Update pagination info
        const paginationInfo = document.getElementById("pagination-info");
        if (paginationInfo) {
          paginationInfo.innerHTML = `
            Showing <span class="font-medium text-white">1</span> to
            <span class="font-medium text-white">${visibleCount}</span> of
            <span class="font-medium text-white">${visibleCount}</span> domains
          `;
        }
      });

      // Add time frame filter functionality
      document.getElementById("time-frame").addEventListener("change", function(event) {
        const timeFrame = event.target.value;
        fetchAnalyticsData(timeFrame);
      });

      // Add DOMContentLoaded event listener back
      document.addEventListener("DOMContentLoaded", () => {
        // Fetch initial analytics data
        fetchAnalyticsData();

        // Initialize charts with empty data
        Object.keys(chartConfigs).forEach((key) => {
          const canvas = document.getElementById(`${key}-chart`);
          if (canvas) {
            charts[key] = new Chart(canvas, chartConfigs[key]);
          }
        });

        // Fetch domains immediately on load
        fetch("/api/domains")
          .then((res) => res.json())
          .then((data) => {
            updateDomainList(data);
          });

        // Start polling for domain updates
        const stopPolling = startPolling();
        window.addEventListener("beforeunload", stopPolling);
      });

      // Add back the polling function
      function startPolling() {
        let isPolling = true;
        let lastUpdateTime = null;

        async function poll() {
          if (!isPolling) return;

          try {
            const response = await fetch("/api/domains");
            const data = await response.json();

            if (data && data.last_updated !== lastUpdateTime) {
              // Update domain list only if we have new data
              const domains = data.domains || [];
              const searchEngines = data.metadata?.search_engines || [];

              // Update UI elements
              document.getElementById("total-domains").textContent = domains.length;
              document.getElementById("found-domains").textContent = domains.length;
              document.getElementById("search-engines").textContent = searchEngines.length;

              // Update search engines table
              const searchEngineTableBody = document.querySelector("#search-engine-list");
              if (searchEngineTableBody) {
                searchEngineTableBody.innerHTML = "";
                searchEngines.forEach((engine) => {
                  const row = document.createElement("tr");
                  row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-gray-300 capitalize">${engine}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-300">${formatDateTime(data.last_updated)}</td>
                  `;
                  searchEngineTableBody.appendChild(row);
                });
              }

              // Update scan duration
              const duration = data.metadata?.crawl_duration || "0s";
              updateScanDuration(duration);

              // Update domains table
              sortedDomains = [...domains].reverse();
              totalPages = Math.max(1, Math.ceil(sortedDomains.length / itemsPerPage));
              if (currentPage > totalPages) currentPage = totalPages;
              renderDomains();

              // Update last update time
              lastUpdateTime = data.last_updated;
              document.getElementById("current-time").textContent = formatDateTime(data.last_updated);
            }

            // Continue polling
            setTimeout(poll, 2000);
          } catch (error) {
            console.error("Polling error:", error);
            setTimeout(poll, 5000);
          }
        }

        // Start polling
        poll();

        // Return function to stop polling
        return () => {
          isPolling = false;
        };
      }
    </script>
  </body>
</html>
